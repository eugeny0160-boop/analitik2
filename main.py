import asyncio
import os
import re
from datetime import datetime, timedelta, timezone
from supabase import create_client
from telegram.ext import Application, CommandHandler, ContextTypes
from telegram import Update
import logging
from flask import Flask, jsonify, request

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler("app.log"),
        logging.StreamHandler()
    ]
)
logger = logging.getLogger(__name__)

# === –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ===
TELEGRAM_TOKEN = os.getenv("TELEGRAM_TOKEN")
TARGET_CHANNEL_ID = int(os.getenv("TARGET_CHANNEL_ID"))  # ID –ø—É–±–ª–∏—á–Ω–æ–≥–æ –∫–∞–Ω–∞–ª–∞
SUPABASE_URL = os.getenv("SUPABASE_URL")
SUPABASE_KEY = os.getenv("SUPABASE_KEY")
PORT = int(os.getenv("PORT", 10000))

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Supabase
supabase = create_client(SUPABASE_URL, SUPABASE_KEY)

# –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏
CATEGORIES = {
    "–†–æ—Å—Å–∏—è": [
        "—Ä–æ—Å—Å–∏—è", "—Ä–æ—Å—Å–∏–π—Å–∫–∞—è", "–º–æ—Å–∫–≤–∞", "–ø—É—Ç–∏–Ω", "–∫—Ä–µ–º–ª—å", "–º–∏–Ω–∏—Å—Ç–µ—Ä—Å—Ç–≤–æ", 
        "–¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç", "—Ñ–µ–¥–µ—Ä–∞—Ü–∏—è", "–º–æ—Å–∫–æ–≤—Å–∫–∞—è", "—Ñ–µ–¥–µ—Ä–∞–ª—å–Ω—ã–π", "–º–æ—Å–∫–æ–≤—Å–∫–∏–π",
        "—Ä–æ—Å—Å–∏–π—Å–∫–∏–π", "–ø—Ä–µ–∑–∏–¥–µ–Ω—Ç", "–¥–º–∏—Ç—Ä–∏–π", "–º–µ–¥–≤–µ–¥–µ–≤", "–º–∏–ª–ª–∏–æ–Ω", "–º–∏–ª–ª–∏–∞—Ä–¥"
    ],
    "–°–í–û": [
        "—Å–≤–æ", "—Å–ø–µ—Ü–æ–ø–µ—Ä–∞—Ü–∏—è", "–≤–æ–µ–Ω–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è", "—Å–ø–µ—Ü–æ–ø–µ—Ä–∞—Ü–∏—è –Ω–∞ –£–∫—Ä–∞–∏–Ω–µ",
        "–≤–æ–µ–Ω–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è –≤ —É–∫—Ä–∞–∏–Ω–µ", "—Å–ø–µ—Ü–æ–ø–µ—Ä–∞—Ü–∏—è –≤ —É–∫—Ä–∞–∏–Ω–µ", "—Å–∏–ª—ã", "–≤–æ–π—Å–∫–∞",
        "—Å–ø–µ—Ü–Ω–∞–∑", "–≤–æ–µ–Ω–Ω–∞—è", "–≤–æ–π–Ω–∞", "–≤–æ–æ—Ä—É–∂–µ–Ω–Ω—ã–µ —Å–∏–ª—ã", "—Ñ–µ–¥–µ—Ä–∞–ª—å–Ω–æ–π —Å–ª—É–∂–±—ã"
    ],
    "–ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞": [
        "–±–∏—Ç–∫–æ–∏–Ω", "—ç—Ñ–∏—Ä–∏—É–º", "–∫—Ä–∏–ø—Ç–æ", "–±–ª–æ–∫—á–µ–π–Ω", "–º–∞–π–Ω–∏–Ω–≥", "—Ç–æ–∫–µ–Ω",
        "—Å—Ç–µ–π–∫–∏–Ω–≥", "–¥–µ—Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π", "–¥–µ—Ñ–∏", "–¥–µ—Ñ–∞–π", "smart contract"
    ],
    "–¢–µ–Ω–¥–µ–Ω—Ü–∏–∏ –≤ –º–∏—Ä–µ": [
        "–º–∏—Ä–æ–≤—ã–µ —Ç–µ–Ω–¥–µ–Ω—Ü–∏–∏", "–≥–ª–æ–±–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–Ω–¥—ã", "—ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–π —Ä–æ—Å—Ç",
        "–¥–µ–º–æ–≥—Ä–∞—Ñ–∏—è", "—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –±—É–¥—É—â–µ–≥–æ", "–º–∏—Ä–æ–≤–æ–π —Ä—ã–Ω–æ–∫", "–º–∏—Ä–æ–≤—ã–µ –ª–∏–¥–µ—Ä—ã",
        "–º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è", "–≥–ª–æ–±–∞–ª—å–Ω–∞—è —ç–∫–æ–Ω–æ–º–∏–∫–∞", "–º–∏—Ä–æ–≤–∞—è –ø–æ–ª–∏—Ç–∏–∫–∞"
    ],
    "–ü–∞–Ω–¥–µ–º–∏—è": [
        "–ø–∞–Ω–¥–µ–º–∏—è", "covid", "–≤–∞–∫—Ü–∏–Ω–∞", "–∫–æ—Ä–æ–Ω–∞–≤–∏—Ä—É—Å", "—ç–ø–∏–¥–µ–º–∏—è", "–≤–∏—Ä—É—Å",
        "–∫–æ–≤–∏–¥", "–º–∞—Å–∫–∏", "–∫–∞—Ä–∞–Ω—Ç–∏–Ω", "–∞–Ω—Ç–∏–∫–æ–≤–∏–¥–Ω—ã–µ –º–µ—Ä—ã", "–∑–∞–±–æ–ª–µ–≤–∞–µ–º–æ—Å—Ç—å"
    ]
}

def get_relevant_articles():
    """–ü–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞—Ç—å–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞ –∏–∑ Supabase"""
    now = datetime.now(timezone.utc)
    yesterday = now - timedelta(days=1)
    
    try:
        response = supabase.table("published_articles") \
            .select("*") \
            .gte("created_at", yesterday.isoformat()) \
            .order("created_at", desc=True) \
            .execute()
        
        logger.info(f"–ü–æ–ª—É—á–µ–Ω–æ {len(response.data)} —Å—Ç–∞—Ç–µ–π –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞")
        return response.data
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–µ–π –∏–∑ Supabase: {e}")
        return []

def categorize_articles(articles):
    """–ö–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç —Å—Ç–∞—Ç—å–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º"""
    categorized = {
        "–†–æ—Å—Å–∏—è": [],
        "–°–í–û": [],
        "–ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞": [],
        "–¢–µ–Ω–¥–µ–Ω—Ü–∏–∏ –≤ –º–∏—Ä–µ": [],
        "–ü–∞–Ω–¥–µ–º–∏—è": []
    }
    
    for article in articles:
        title = article["title"].lower()
        url = article["url"]
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        for category, keywords in CATEGORIES.items():
            if any(keyword in title for keyword in keywords):
                categorized[category].append({
                    "title": article["title"],
                    "url": url
                })
                break  # –û–¥–Ω–∞ —Å—Ç–∞—Ç—å—è - –æ–¥–Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è
    
    return categorized

def generate_analytical_summary(categorized_articles):
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫—É—é –∑–∞–ø–∏—Å–∫—É –ø–æ —à–∞–±–ª–æ–Ω—É"""
    total_articles = sum(len(articles) for articles in categorized_articles.values())
    
    # 1. –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —Ä–µ–∑—é–º–µ (10%)
    executive_summary = f"1. –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —Ä–µ–∑—é–º–µ\n"
    if total_articles > 0:
        executive_summary += (
            f"–ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ {total_articles} –Ω–æ–≤—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤. "
            "–ê–Ω–∞–ª–∏–∑ –≤—ã—è–≤–∏–ª –∫–ª—é—á–µ–≤—ã–µ —Ç–µ–Ω–¥–µ–Ω—Ü–∏–∏ –≤ —Å–ª–µ–¥—É—é—â–∏—Ö –æ–±–ª–∞—Å—Ç—è—Ö: "
        )
        
        # –£–∫–∞–∂–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —Å—Ç–∞—Ç–µ–π
        main_categories = [
            f"{cat} ({len(arts)})" 
            for cat, arts in categorized_articles.items() 
            if len(arts) > 0
        ]
        executive_summary += ", ".join(main_categories) + ".\n\n"
        
        executive_summary += (
            "–û—Å–æ–±–æ–µ –≤–Ω–∏–º–∞–Ω–∏–µ —Ç—Ä–µ–±—É—é—Ç —Å–æ–±—ã—Ç–∏—è, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –†–æ—Å—Å–∏–µ–π –∏ –≥–µ–æ–ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–∏–º–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞–º–∏, "
            "–∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –æ–∫–∞–∑–∞—Ç—å —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –≤–ª–∏—è–Ω–∏–µ –Ω–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é –∏ –≤–Ω–µ—à–Ω—é—é –ø–æ–ª–∏—Ç–∏–∫—É –†–§."
        )
    else:
        executive_summary += "–ù–µ—Ç –Ω–æ–≤—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞."
    
    # 2. –¢–û–ü-5 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–æ–±—ã—Ç–∏–π (25%)
    top_events = []
    for category, articles in categorized_articles.items():
        for article in articles[:2]:  # –ë–µ—Ä–µ–º –ø–æ 2 —Å—Ç–∞—Ç—å–∏ –∏–∑ –∫–∞–∂–¥–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            top_events.append({
                "category": category,
                "title": article["title"],
                "url": article["url"]
            })
    
    # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¢–û–ü-5
    top_events = top_events[:5]
    
    top_events_section = "2. –¢–û–ü-5 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–æ–±—ã—Ç–∏–π –ø–µ—Ä–∏–æ–¥–∞\n"
    if top_events:
        for i, event in enumerate(top_events, 1):
            event_summary = (
                f"–°–æ–±—ã—Ç–∏–µ ‚Ññ{i}: {event['title']}\n"
                f"‚Ä¢ –û–ø–∏—Å–∞–Ω–∏–µ: {event['title']} [{event['url']}]\n"
                f"‚Ä¢ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –≤–∞–∂–Ω–æ—Å—Ç—å: –°–æ–±—ã—Ç–∏–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏ –¥–ª—è –†–§.\n"
                f"‚Ä¢ –í–ª–∏—è–Ω–∏–µ –Ω–∞ –†–æ—Å—Å–∏—é: –û–∂–∏–¥–∞–µ–º—ã–µ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –ø–æ–ª–∏—Ç–∏–∫–∏ –∏ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã—Ö –æ—Ç–Ω–æ—à–µ–Ω–∏–π.\n"
                f"‚Ä¢ –í–ª–∏—è–Ω–∏–µ –Ω–∞ –ö–∏—Ç–∞–π/–ï–≤—Ä–∞–∑–∏—é: –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è –¥–ª—è —Ä–µ–≥–∏–æ–Ω–∞–ª—å–Ω–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏.\n"
                f"‚Ä¢ –ì–ª–æ–±–∞–ª—å–Ω–æ–µ –≤–ª–∏—è–Ω–∏–µ: –ò–∑–º–µ–Ω–µ–Ω–∏–µ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –±–∞–ª–∞–Ω—Å–∞ —Å–∏–ª.\n"
                f"‚Ä¢ –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–µ —Ä–∞–∑–≤–∏—Ç–∏–µ: –í–µ—Ä–æ—è—Ç–Ω–æ–µ —Ä–∞–∑–≤–∏—Ç–∏–µ —Å–æ–±—ã—Ç–∏–π –≤ –∫—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω–æ–π –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–µ.\n"
            )
            top_events_section += event_summary + "\n"
    else:
        top_events_section += "–ù–µ—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–æ–±—ã—Ç–∏–π –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è –≤ –¢–û–ü-5.\n"
    
    # 3. –î–µ—Ç–∞–ª—å–Ω—ã–π —Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ (30%)
    thematic_analysis = "3. –î–µ—Ç–∞–ª—å–Ω—ã–π —Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑\n"
    for category, articles in categorized_articles.items():
        if articles:
            thematic_analysis += f"\n‚Ä¢ {category}\n"
            for article in articles[:3]:  # –ù–µ –±–æ–ª–µ–µ 3 —Å—Ç–∞—Ç–µ–π –Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—é
                thematic_analysis += f"  - {article['title']} [{article['url']}]\n"
            
            # –¢—Ä–µ–Ω–¥—ã –∏ –∑–∞–∫–æ–Ω–æ–º–µ—Ä–Ω–æ—Å—Ç–∏
            if len(articles) > 1:
                thematic_analysis += f"  ‚Ä¢ –¢—Ä–µ–Ω–¥—ã: –ù–∞–±–ª—é–¥–∞–µ—Ç—Å—è —Ä–æ—Å—Ç –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –ø–æ –¥–∞–Ω–Ω–æ–π —Ç–µ–º–µ.\n"
            else:
                thematic_analysis += "  ‚Ä¢ –¢—Ä–µ–Ω–¥—ã: –ï–¥–∏–Ω–∏—á–Ω—ã–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏, —Ç—Ä–µ–±—É—é—â–∏–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞.\n"
    
    # 4. –£–≥–ª—É–±–ª–µ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –≤–ª–∏—è–Ω–∏—è –Ω–∞ –†–æ—Å—Å–∏—é (15%)
    russia_analysis = (
        "4. –£–≥–ª—É–±–ª–µ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –≤–ª–∏—è–Ω–∏—è –Ω–∞ –†–æ—Å—Å–∏—é\n"
        "‚Ä¢ –ü—Ä—è–º—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã:\n"
        "  o –≠–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–µ: –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–µ –≤–ª–∏—è–Ω–∏–µ –Ω–∞ —Ä—É–±–ª—å –∏ —ç–∫—Å–ø–æ—Ä—Ç.\n"
        "  o –ü–æ–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ: –í–ª–∏—è–Ω–∏–µ –Ω–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é –ø–æ–ª–∏—Ç–∏—á–µ—Å–∫—É—é –æ–±—Å—Ç–∞–Ω–æ–≤–∫—É.\n"
        "  o –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —É–≥—Ä–æ–∑—ã –Ω–∞—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.\n"
        "  o –°–æ—Ü–∏–∞–ª—å–Ω—ã–µ: –í–ª–∏—è–Ω–∏–µ –Ω–∞ –æ–±—â–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –º–Ω–µ–Ω–∏–µ.\n"
        "‚Ä¢ –ö–æ—Å–≤–µ–Ω–Ω—ã–µ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è: –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –†–æ—Å—Å–∏–∏ –Ω–∞ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–æ–π –∞—Ä–µ–Ω–µ.\n"
        "‚Ä¢ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏: –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª –¥–ª—è —Ä–∞–∑–≤–∏—Ç–∏—è –Ω–æ–≤—ã—Ö –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–∞.\n"
        "‚Ä¢ –†–∏—Å–∫–∏: –£–≥—Ä–æ–∑—ã –¥–ª—è —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–æ–π –∏ –ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–æ–π —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏.\n"
        "‚Ä¢ –†–∞–∑–≤–∏—Ç–∏–µ —Å–∏—Ç—É–∞—Ü–∏–∏: –ü—Ä–æ–≥–Ω–æ–∑—ã –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–æ–±—ã—Ç–∏—è–º.\n"
    )
    
    # 5. –í–ª–∏—è–Ω–∏–µ –Ω–∞ –ö–∏—Ç–∞–π –∏ –ï–≤—Ä–∞–∑–∏—é (10%)
    china_analysis = (
        "5. –í–ª–∏—è–Ω–∏–µ –Ω–∞ –ö–∏—Ç–∞–π –∏ –ï–≤—Ä–∞–∑–∏—é\n"
        "‚Ä¢ –ö–ª—é—á–µ–≤—ã–µ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è: –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–µ –≤–ª–∏—è–Ω–∏–µ –Ω–∞ –∫–∏—Ç–∞–π—Å–∫–æ-—Ä–æ—Å—Å–∏–π—Å–∫–∏–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è.\n"
        "‚Ä¢ –°–≤—è–∑—å —Å —Ä–æ—Å—Å–∏–π—Å–∫–∏–º–∏ –∏–Ω—Ç–µ—Ä–µ—Å–∞–º–∏: –£—Å–∏–ª–µ–Ω–∏–µ —Ä–µ–≥–∏–æ–Ω–∞–ª—å–Ω–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏.\n"
    )
    
    # 6. –í–ª–∏—è–Ω–∏–µ –Ω–∞ –º–∏—Ä–æ–≤—É—é –æ–±—Å—Ç–∞–Ω–æ–≤–∫—É (10%)
    global_analysis = (
        "6. –í–ª–∏—è–Ω–∏–µ –Ω–∞ –º–∏—Ä–æ–≤—É—é –æ–±—Å—Ç–∞–Ω–æ–≤–∫—É\n"
        "‚Ä¢ –ò–∑–º–µ–Ω–µ–Ω–∏–µ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –±–∞–ª–∞–Ω—Å–∞: –°–¥–≤–∏–≥–∏ –≤ –≥–µ–æ–ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏.\n"
        "‚Ä¢ –†–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã–µ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è: –ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è –¥–ª—è –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Ä–µ–≥–∏–æ–Ω–æ–≤.\n"
        "‚Ä¢ –°–∏—Å—Ç–µ–º–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã: –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã—Ö –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö.\n"
    )
    
    # 7. –í—ã–≤–æ–¥—ã –∏ –ø—Ä–æ–≥–Ω–æ–∑—ã (5%)
    conclusions = (
        "7. –í—ã–≤–æ–¥—ã –∏ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–æ–≥–Ω–æ–∑—ã\n"
        "‚Ä¢ –ö–ª—é—á–µ–≤—ã–µ —Ç–µ–Ω–¥–µ–Ω—Ü–∏–∏ –ø–µ—Ä–∏–æ–¥–∞: –†–æ—Å—Ç –≥–µ–æ–ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–æ–π –Ω–∞–ø—Ä—è–∂–µ–Ω–Ω–æ—Å—Ç–∏.\n"
        "‚Ä¢ –ü—Ä–æ–≥–Ω–æ–∑—ã: –í—ã—Å–æ–∫–∞—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –¥–∞–ª—å–Ω–µ–π—à–µ–π —ç—Å–∫–∞–ª–∞—Ü–∏–∏ –≤ –∫—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω–æ–π –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–µ.\n"
        "‚Ä¢ –§–∞–∫—Ç–æ—Ä—ã –Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ—Å—Ç–∏: –í–Ω–µ—à–Ω–∏–µ —à–æ–∫–∏ –∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Ñ–∞–∫—Ç–æ—Ä—ã.\n"
        "‚Ä¢ –ß—Ç–æ —Ç—Ä–µ–±—É–µ—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞: –°–∏—Ç—É–∞—Ü–∏—è –≤ —Ä–µ–≥–∏–æ–Ω–µ –∏ –¥–∏–Ω–∞–º–∏–∫–∞ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã—Ö –æ—Ç–Ω–æ—à–µ–Ω–∏–π.\n"
    )
    
    # –°–±–æ—Ä–∫–∞ –ø–æ–ª–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞
    full_report = (
        executive_summary + "\n\n" +
        top_events_section + "\n\n" +
        thematic_analysis + "\n\n" +
        russia_analysis + "\n\n" +
        china_analysis + "\n\n" +
        global_analysis + "\n\n" +
        conclusions
    )
    
    # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –æ–±—ä–µ–º–∞ (–º–∞–∫—Å–∏–º—É–º 2000 –∑–Ω–∞–∫–æ–≤)
    return full_report[:2000]

async def generate_report(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –æ—Ç—á–µ—Ç –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤ –∫–∞–Ω–∞–ª"""
    try:
        # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç—å–∏ –∏–∑ Supabase
        articles = get_relevant_articles()
        
        # –ö–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–µ–º –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
        categorized = categorize_articles(articles)
        
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç—á–µ—Ç
        report = generate_analytical_summary(categorized)
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –∫–∞–Ω–∞–ª
        await context.bot.send_message(
            chat_id=TARGET_CHANNEL_ID,
            text=report,
            parse_mode="HTML"
        )
        
        await update.message.reply_text("‚úÖ –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –æ—Ç—á—ë—Ç —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!")
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á—ë—Ç–∞: {e}")
        await update.message.reply_text(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á—ë—Ç–∞: {str(e)}")

async def trigger_report(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á—ë—Ç–∞"""
    await generate_report(update, context)

# === Flask —Å–µ—Ä–≤–µ—Ä –¥–ª—è –≤–µ–±-—Å–æ–±—ã—Ç–∏–π ===
flask_app = Flask(__name__)

@flask_app.route("/generate-report", methods=['GET'])
def generate_report_webhook():
    """–í–µ–±-—ç–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á—ë—Ç–∞"""
    try:
        # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç—å–∏ –∏–∑ Supabase
        articles = get_relevant_articles()
        categorized = categorize_articles(articles)
        report = generate_analytical_summary(categorized)
        
        return jsonify({
            "status": "success",
            "report": report,
            "article_count": sum(len(articles) for articles in categorized.values())
        }), 200
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á—ë—Ç–∞ —á–µ—Ä–µ–∑ –≤–µ–±: {e}")
        return jsonify({
            "status": "error",
            "message": str(e)
        }), 500

@flask_app.route("/health", methods=['GET'])
def health_check():
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–∞"""
    return jsonify({
        "status": "healthy",
        "service": "analytical-bot",
        "timestamp": datetime.now(timezone.utc).isoformat()
    }), 200

@flask_app.route("/", methods=['GET'])
def home():
    """–°—Ç–∞—Ä—Ç–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞"""
    return "ü§ñ –§–∏–Ω–∞–Ω—Å–∏—Å—Ç-–ê–Ω–∞–ª–∏—Ç–∏–∫: –ë–æ—Ç –∞–∫—Ç–∏–≤–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á—ë—Ç–æ–≤", 200

# === –û—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ø—É—Å–∫ ===
def main():
    # –ó–∞–ø—É—Å–∫–∞–µ–º Flask-—Å–µ—Ä–≤–µ—Ä –≤ —Ñ–æ–Ω–µ
    from threading import Thread
    Thread(target=flask_app.run, kwargs={
        'host': '0.0.0.0',
        'port': PORT,
        'debug': False
    }, daemon=True).start()
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º Telegram-–±–æ—Ç–∞
    app = Application.builder().token(TELEGRAM_TOKEN).build()
    app.add_handler(CommandHandler("generate_report", generate_report))
    app.add_handler(CommandHandler("trigger", trigger_report))
    
    logger.info("üöÄ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω. –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã: /generate_report")
    app.run_polling()

if __name__ == "__main__":
    main()
