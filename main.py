import asyncio
from datetime import datetime, timedelta, timezone
from supabase import create_client
from telegram.ext import Application
from telegram import Update
import os
from flask import Flask, request, jsonify

# === –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ===
TELEGRAM_TOKEN = os.getenv("TELEGRAM_TOKEN")
TARGET_CHANNEL_ID = int(os.getenv("TARGET_CHANNEL_ID"))
SUPABASE_URL = os.getenv("SUPABASE_URL")
SUPABASE_KEY = os.getenv("SUPABASE_KEY")

# === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Supabase ===
supabase = create_client(SUPABASE_URL, SUPABASE_KEY)

# –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏–∏
CATEGORIES = {
    "–†–æ—Å—Å–∏—è": ["–†–æ—Å—Å–∏—è", "Russia", "—Ä–æ—Å—Å–∏–π—Å–∫", "russo", "russe", "rusia", "russland", "–ü—É—Ç–∏–Ω", "–ö—Ä–µ–º–ª—å", "–ú–ò–î", "–§–°–ë"],
    "–°–í–û": ["–°–í–û", "—Å–ø–µ—Ü–æ–ø–µ—Ä–∞—Ü–∏—è", "—É–∫—Ä–∞–∏–Ω–∞", "–≤–æ–π–Ω–∞", "–≤–æ–µ–Ω", "–∞—Ä–º–∏—è", "—Ä–∞–∫–µ—Ç–∞", "–æ—Ä—É–∂–∏–µ", "—Ñ—Ä–æ–Ω", "–≥—Ä–∞–Ω–∏—Ü", "–æ–∫–∫—É–ø–∞—Ü–∏—è", "—Ç–µ—Ä—Ä–æ—Ä–∏–∑–º"],
    "–ö—Ä–∏–ø—Ç–æ–≤–æ–ª—é—Ç–∞": ["–∫—Ä–∏–ø—Ç–æ", "–±–∏—Ç–∫–æ–∏–Ω", "–±–ª–æ–∫—á–µ–π–Ω", "—ç—Ñ–∏—Ä–∏—É–º", "NFT", "DeFi", "–º–∞–π–Ω–∏–Ω–≥", "–±–∏—Ä–∂–∞", "—Ä–µ–≥—É–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—Ä–∏–ø—Ç–æ", "—Ü–∏—Ñ—Ä–æ–≤–∞—è –≤–∞–ª—é—Ç–∞"],
    "–¢–µ–Ω–¥–µ–Ω—Ü–∏–∏ –≤ –ú–∏—Ä–µ": ["–º–∏—Ä", "–≥–ª–æ–±–∞–ª—å–Ω—ã–π", "—ç–∫–æ–Ω–æ–º–∏–∫–∞", "—Ñ–∏–Ω–∞–Ω—Å", "—Ç–æ—Ä–≥–æ–≤–ª—è", "—Å–¥–µ–ª–∫–∞", "—Å–∞–Ω–∫—Ü–∏–∏", "–Ω–µ—Ñ—Ç—å", "–≥–∞–∑", "—ç–Ω–µ—Ä–≥–∏—è", "–∫–ª–∏–º–∞—Ç", "—ç–∫–æ–ª–æ–≥–∏—è", "—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏", "AI", "–ò–ò", "–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å", "–∫–æ–Ω—Ñ–ª–∏–∫—Ç", "–ø–µ—Ä–µ–≥–æ–≤–æ—Ä—ã", "–¥–∏–ø–ª–æ–º–∞—Ç–∏—è"],
    "–ü–∞–Ω–¥–µ–º–∏—è": ["–ø–∞–Ω–¥–µ–º–∏—è", "COVID", "–∫–æ—Ä–æ–Ω–∞–≤–∏—Ä—É—Å", "–≤–∞–∫—Ü–∏–Ω–∞", "–∑–¥–æ—Ä–æ–≤—å–µ", "–±–æ–ª–µ–∑–Ω—å", "–ª–µ–∫–∞—Ä—Å—Ç–≤–æ", "–º–µ–¥–∏—Ü–∏–Ω", "—ç–ø–∏–¥–µ–º–∏—è"]
}

def categorize_article(content: str) -> list:
    """–ö–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç —Å—Ç–∞—Ç—å—é –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º."""
    categories = []
    content_lower = content.lower()
    for category, keywords in CATEGORIES.items():
        if any(kw.lower() in content_lower for kw in keywords):
            categories.append(category)
    return categories or ["–ü—Ä–æ—á–µ–µ"]

def generate_analytical_summary(articles):
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫—É—é –∑–∞–ø–∏—Å–∫—É –ø–æ —Å—Ç—Ä–æ–≥–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ."""
    now = datetime.now(timezone.utc)
    yesterday = now - timedelta(days=1)

    # 1. –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —Ä–µ–∑—é–º–µ (10%)
    summary_lines = [
        f"1. –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —Ä–µ–∑—é–º–µ",
        f"–ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ {len(articles)} –Ω–æ–≤–æ—Å—Ç–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤. –ö–ª—é—á–µ–≤—ã–µ —Ç–µ–º—ã: {', '.join(set(cat for art in articles for cat in categorize_article(art['title'] + ' ' + art['content']))}. –í—Å–µ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω—ã –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏.",
        ""
    ]

    # 2. –¢–û–ü-5 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–æ–±—ã—Ç–∏–π (25%)
    # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ (—Å–∞–º—ã–µ —Å–≤–µ–∂–∏–µ –ø–µ—Ä–≤—ã–º–∏) –∏ –±–µ—Ä–µ–º 5
    top_events = sorted(articles, key=lambda x: x.get('created_at', ''), reverse=True)[:5]
    summary_lines.append("2. –¢–û–ü-5 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–æ–±—ã—Ç–∏–π –ø–µ—Ä–∏–æ–¥–∞")
    for i, event in enumerate(top_events, 1):
        url = event["url"]
        title = event["title"]
        content = event["content"][:300] + "..." if len(event["content"]) > 300 else event["content"]
        categories = categorize_article(title + " " + content)

        summary_lines.extend([
            f"–°–æ–±—ã—Ç–∏–µ ‚Ññ{i}: {title}",
            f"‚Ä¢	–û–ø–∏—Å–∞–Ω–∏–µ: {content} [{url}]",
            f"‚Ä¢	–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –≤–∞–∂–Ω–æ—Å—Ç—å: –°–æ–±—ã—Ç–∏–µ –Ω–∞–ø—Ä—è–º—É—é –∑–∞—Ç—Ä–∞–≥–∏–≤–∞–µ—Ç —Å—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∏–µ –∏–Ω—Ç–µ—Ä–µ—Å—ã –†–æ—Å—Å–∏–∏ –∏ –∏–º–µ–µ—Ç –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª –∏–∑–º–µ–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å —Å–∏–ª –≤ —Ä–µ–≥–∏–æ–Ω–µ.",
            f"‚Ä¢	–í–ª–∏—è–Ω–∏–µ –Ω–∞ –†–æ—Å—Å–∏—é: –ü—Ä—è–º—ã–µ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è –≤–∫–ª—é—á–∞—é—Ç [–ø—Ä–∏–º–µ—Ä: —É—Å–∏–ª–µ–Ω–∏–µ —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–æ–π –∏–∑–æ–ª—è—Ü–∏–∏]. –ö–æ—Å–≤–µ–Ω–Ω–æ ‚Äî —É–∂–µ—Å—Ç–æ—á–µ–Ω–∏–µ –≤–Ω–µ—à–Ω–µ–ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–æ–π –∏–∑–æ–ª—è—Ü–∏–∏ –∏ –ø–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö —Ü–µ–ø–æ—á–µ–∫ –ø–æ—Å—Ç–∞–≤–æ–∫. [{url}]",
            f"‚Ä¢	–í–ª–∏—è–Ω–∏–µ –Ω–∞ –ö–∏—Ç–∞–π/–ï–≤—Ä–∞–∑–∏—é: –°–æ–±—ã—Ç–∏–µ —É–∫—Ä–µ–ø–ª—è–µ—Ç —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–æ–µ –∏ –ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–æ –º–µ–∂–¥—É –†–æ—Å—Å–∏–µ–π –∏ —Å—Ç—Ä–∞–Ω–∞–º–∏ –ï–≤—Ä–∞–∑–∏–π—Å–∫–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞. [{url}]",
            f"‚Ä¢	–ì–ª–æ–±–∞–ª—å–Ω–æ–µ –≤–ª–∏—è–Ω–∏–µ: –£—Å–∏–ª–∏–≤–∞–µ—Ç –Ω–∞–ø—Ä—è–∂—ë–Ω–Ω–æ—Å—Ç—å –≤ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ, –æ—Å–ª–∞–±–ª—è–µ—Ç —Ä–æ–ª—å –∑–∞–ø–∞–¥–Ω—ã—Ö –∏–Ω—Å—Ç–∏—Ç—É—Ç–æ–≤ –∏ —É—Å–∫–æ—Ä—è–µ—Ç —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –º–Ω–æ–≥–æ–ø–æ–ª—è—Ä–Ω–æ–≥–æ –ø–æ—Ä—è–¥–∫–∞. [{url}]",
            f"‚Ä¢	–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–µ —Ä–∞–∑–≤–∏—Ç–∏–µ: –ü—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ç–µ–∫—É—â–µ–π —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏ –æ–∂–∏–¥–∞–µ—Ç—Å—è –¥–∞–ª—å–Ω–µ–π—à–µ–µ —É–∂–µ—Å—Ç–æ—á–µ–Ω–∏–µ —Å–∞–Ω–∫—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ –∏ –ø–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤ –≤ —Å—Ç–æ—Ä–æ–Ω—É –ê–∑–∏–∏. –°—Ü–µ–Ω–∞—Ä–∏–π –∏–º–µ–µ—Ç –≤—ã—Å–æ–∫—É—é –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏. [{url}]",
            ""
        ])

    # 3. –î–µ—Ç–∞–ª—å–Ω—ã–π —Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ (30%)
    summary_lines.append("3. –î–µ—Ç–∞–ª—å–Ω—ã–π —Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑")
    for category in CATEGORIES.keys():
        category_articles = [art for art in articles if category in categorize_article(art['title'] + ' ' + art['content'])]
        if category_articles:
            summary_lines.append(f"‚Ä¢	{category}")
            for art in category_articles[:3]:  # –ë–µ—Ä—ë–º 3 —Å–∞–º—ã—Ö —Å–≤–µ–∂–∏—Ö –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                summary_lines.append(f"  ‚Äì {art['title']} [{art['url']}]")

    # 4. –£–≥–ª—É–±–ª–µ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –≤–ª–∏—è–Ω–∏—è –Ω–∞ –†–æ—Å—Å–∏—é (15%)
    summary_lines.append("\n4. –£–≥–ª—É–±–ª–µ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –≤–ª–∏—è–Ω–∏—è –Ω–∞ –†–æ—Å—Å–∏—é")
    summary_lines.extend([
        "‚Ä¢	–ü—Ä—è–º—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã:",
        "o	–≠–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–µ: –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ç–æ—Ä–≥–æ–≤—ã—Ö –ø–æ—Ç–æ–∫–∞—Ö –∏ –≤–∞–ª—é—Ç–Ω–æ–π –ø–æ–ª–∏—Ç–∏–∫–µ —É—Å–∏–ª–∏–≤–∞—é—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç –∞–∑–∏–∞—Ç—Å–∫–∏—Ö —Ä—ã–Ω–∫–æ–≤. [https://example.com]",
        "o	–ü–æ–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ: –£—Å–∏–ª–∏–≤–∞–µ—Ç—Å—è —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–∞—Ü–∏—è –≤–ª–∞—Å—Ç–∏ –∏ –∫–æ–Ω—Å–æ–ª–∏–¥–∞—Ü–∏—è –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∞–ø–ø–∞—Ä–∞—Ç–∞ –≤ –æ—Ç–≤–µ—Ç –Ω–∞ –≤–Ω–µ—à–Ω–µ–µ –¥–∞–≤–ª–µ–Ω–∏–µ. [https://example.com]",
        "o	–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: –£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è –Ω–∞–ø—Ä—è–∂—ë–Ω–Ω–æ—Å—Ç—å –Ω–∞ –≥—Ä–∞–Ω–∏—Ü–∞—Ö –∏ —Ä–∞—Å—Ç—ë—Ç —Ä–æ–ª—å –≤–æ–µ–Ω–Ω–æ-–ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ–≥–æ –∫–æ–º–ø–ª–µ–∫—Å–∞. [https://example.com]",
        "o	–°–æ—Ü–∏–∞–ª—å–Ω—ã–µ: –†–æ—Å—Ç –∏–Ω—Ñ–ª—è—Ü–∏–∏ –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞ –∫ –∑–∞—Ä—É–±–µ–∂–Ω—ã–º —É—Å–ª—É–≥–∞–º –≤–ª–∏—è—é—Ç –Ω–∞ —É—Ä–æ–≤–µ–Ω—å –∂–∏–∑–Ω–∏. [https://example.com]",
        "‚Ä¢	–ö–æ—Å–≤–µ–Ω–Ω—ã–µ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è: –°—Ç—Ä—É–∫—Ç—É—Ä–Ω–∞—è –ø–µ—Ä–µ—Å—Ç—Ä–æ–π–∫–∞ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö —Ü–µ–ø–æ—á–µ–∫ –ø–æ—Å—Ç–∞–≤–æ–∫ —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –¥–ª—è –∏–º–ø–æ—Ä—Ç–æ–∑–∞–º–µ—â–µ–Ω–∏—è, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã—Ö –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π. [https://example.com]",
        "‚Ä¢	–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏: –£–∫—Ä–µ–ø–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–π –≤ –ï–≤—Ä–∞–∑–∏–∏, —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–∞ —Å –ö–∏—Ç–∞–µ–º, –ò–Ω–¥–∏–µ–π –∏ —Å—Ç—Ä–∞–Ω–∞–º–∏ –ë–ª–∏–∂–Ω–µ–≥–æ –í–æ—Å—Ç–æ–∫–∞. [https://example.com]",
        "‚Ä¢	–†–∏—Å–∫–∏: –†–∏—Å–∫ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ –æ—Ç—Å—Ç–∞–≤–∞–Ω–∏—è, –¥–µ—Ñ–∏—Ü–∏—Ç –∫–≤–∞–ª–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∫–∞–¥—Ä–æ–≤, —É—Ö—É–¥—à–µ–Ω–∏–µ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω–æ–≥–æ –∫–ª–∏–º–∞—Ç–∞. [https://example.com]",
        "‚Ä¢	–†–∞–∑–≤–∏—Ç–∏–µ —Å–∏—Ç—É–∞—Ü–∏–∏: –°–∏—Ç—É–∞—Ü–∏—è –æ—Å—Ç–∞—ë—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–Ω–æ–π. –ü–æ—Å–ª–µ–¥–Ω–∏–µ –¥–∞–Ω–Ω—ã–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã –Ω–∞ {now.strftime('%d.%m.%Y %H:%M')} UTC. [https://example.com]"
    ])

    # 5. –í–ª–∏—è–Ω–∏–µ –Ω–∞ –ö–∏—Ç–∞–π –∏ –ï–≤—Ä–∞–∑–∏—é (10%)
    summary_lines.append("\n5. –í–ª–∏—è–Ω–∏–µ –Ω–∞ –ö–∏—Ç–∞–π –∏ –ï–≤—Ä–∞–∑–∏—é")
    summary_lines.extend([
        "‚Ä¢	–ö–ª—é—á–µ–≤—ã–µ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è: –£—Å–∏–ª–µ–Ω–∏–µ —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–æ–π –∏ –ª–æ–≥–∏—Å—Ç–∏—á–µ—Å–∫–æ–π –≤–∑–∞–∏–º–æ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —Å –†–æ—Å—Å–∏–µ–π, —Ä–æ—Å—Ç –æ–±—ä—ë–º–æ–≤ —ç–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏—Ö –ø–æ—Å—Ç–∞–≤–æ–∫, —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Å–æ–≤–º–µ—Å—Ç–Ω—ã—Ö –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤. [https://example.com]",
        "‚Ä¢	–°–≤—è–∑—å —Å —Ä–æ—Å—Å–∏–π—Å–∫–∏–º–∏ –∏–Ω—Ç–µ—Ä–µ—Å–∞–º–∏: –ö–∏—Ç–∞–π —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –∫–ª—é—á–µ–≤—ã–º –ø–∞—Ä—Ç–Ω—ë—Ä–æ–º –≤ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏–∏ —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏ —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–æ–π —Å–∏—Å—Ç–µ–º—ã –∏ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è–º. [https://example.com]"
    ])

    # 6. –í–ª–∏—è–Ω–∏–µ –Ω–∞ –º–∏—Ä–æ–≤—É—é –æ–±—Å—Ç–∞–Ω–æ–≤–∫—É (10%)
    summary_lines.append("\n6. –í–ª–∏—è–Ω–∏–µ –Ω–∞ –º–∏—Ä–æ–≤—É—é –æ–±—Å—Ç–∞–Ω–æ–≤–∫—É")
    summary_lines.extend([
        "‚Ä¢	–ò–∑–º–µ–Ω–µ–Ω–∏–µ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –±–∞–ª–∞–Ω—Å–∞: –°–Ω–∏–∂–µ–Ω–∏–µ –≤–ª–∏—è–Ω–∏—è –∑–∞–ø–∞–¥–Ω—ã—Ö –∏–Ω—Å—Ç–∏—Ç—É—Ç–æ–≤, —Ä–æ—Å—Ç —Ä–æ–ª–∏ –ë–†–ò–ö–° –∏ —Ä–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã—Ö –∞–ª—å—è–Ω—Å–æ–≤. [https://example.com]",
        "‚Ä¢	–†–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã–µ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è: –í –ï–≤—Ä–æ–ø–µ ‚Äî —É–≥–ª—É–±–ª–µ–Ω–∏–µ —ç–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–æ–≥–æ –∫—Ä–∏–∑–∏—Å–∞; –≤ –°–®–ê ‚Äî —É—Å–∏–ª–µ–Ω–∏–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–æ–π –ø–æ–ª—è—Ä–∏–∑–∞—Ü–∏–∏; –≤ –ë–ª–∏–∂–Ω–µ–º –í–æ—Å—Ç–æ–∫–µ ‚Äî —Ä–æ—Å—Ç —Ä–æ–ª–∏ –∫–∞–∫ –ø–æ—Å—Ä–µ–¥–Ω–∏–∫–∞; –≤ –ê—Ñ—Ä–∏–∫–µ ‚Äî —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ç–æ—Ä–≥–æ–≤—ã—Ö —Å–≤—è–∑–µ–π —Å –†–æ—Å—Å–∏–µ–π –∏ –ö–∏—Ç–∞–µ–º. [https://example.com]",
        "‚Ä¢	–°–∏—Å—Ç–µ–º–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã: –£—Å–∫–æ—Ä–µ–Ω–∏–µ –¥–µ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –æ–¥–Ω–æ–ø–æ–ª—è—Ä–Ω–æ–≥–æ –º–∏—Ä–æ–≤–æ–≥–æ –ø–æ—Ä—è–¥–∫–∞ –∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –º–Ω–æ–≥–æ–ø–æ–ª—è—Ä–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã —Å —É—Å–∏–ª–µ–Ω–∏–µ–º –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏ –º–µ–∂–¥—É –±–ª–æ–∫–∞–º–∏. [https://example.com]"
    ])

    # 7. –í—ã–≤–æ–¥—ã –∏ –ø—Ä–æ–≥–Ω–æ–∑—ã (5%)
    summary_lines.append("\n7. –í—ã–≤–æ–¥—ã –∏ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–æ–≥–Ω–æ–∑—ã")
    summary_lines.extend([
        "‚Ä¢	–ö–ª—é—á–µ–≤—ã–µ —Ç–µ–Ω–¥–µ–Ω—Ü–∏–∏ –ø–µ—Ä–∏–æ–¥–∞: –≠–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∞—è –∏–∑–æ–ª—è—Ü–∏—è –†–æ—Å—Å–∏–∏, —É–∫—Ä–µ–ø–ª–µ–Ω–∏–µ –ï–≤—Ä–∞–∑–∏–π—Å–∫–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏, –¥–µ—Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—è –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö —Ü–µ–ø–æ—á–µ–∫ –ø–æ—Å—Ç–∞–≤–æ–∫, —É—Å–∫–æ—Ä–µ–Ω–∏–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ —Å–¥–≤–∏–≥–∞.",
        "‚Ä¢	–ü—Ä–æ–≥–Ω–æ–∑—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ñ–∞–∫—Ç–æ–≤:",
        "  ‚Äî –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Å–∞–Ω–∫—Ü–∏–æ–Ω–Ω–æ–≥–æ –¥–∞–≤–ª–µ–Ω–∏—è —Å —É–∂–µ—Å—Ç–æ—á–µ–Ω–∏–µ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –Ω–∞ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ ‚Äî –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –≤—ã—Å–æ–∫–∞—è. [https://example.com]",
        "  ‚Äî –°—Ü–µ–Ω–∞—Ä–∏–π 2: –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ç–æ—Ä–≥–æ–≤—ã—Ö —Å–≤—è–∑–µ–π –†–æ—Å—Å–∏–∏ —Å –ö–∏—Ç–∞–µ–º –∏ –ò–Ω–¥–∏–µ–π –¥–æ 40% –æ—Ç –æ–±—â–µ–≥–æ –æ–±—ä—ë–º–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ ‚Äî –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Å—Ä–µ–¥–Ω—è—è. [https://example.com]",
        "  ‚Äî –°—Ü–µ–Ω–∞—Ä–∏–π 3: –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã SWIFT, —Ä—É–±–ª—å-—é–∞–Ω—å) ‚Äî –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –≤—ã—Å–æ–∫–∞—è. [https://example.com]",
        "‚Ä¢	–§–∞–∫—Ç–æ—Ä—ã –Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ—Å—Ç–∏: –≠–≤–æ–ª—é—Ü–∏—è –ø–æ–∑–∏—Ü–∏–∏ –ö–∏—Ç–∞—è –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏–∏ –£–∫—Ä–∞–∏–Ω—ã, —Ä–µ–∞–∫—Ü–∏—è –°–®–ê –Ω–∞ —Å–∞–Ω–∫—Ü–∏–æ–Ω–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è, –≤–æ–∑–º–æ–∂–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–µ –ï–°.",
        "‚Ä¢	–ß—Ç–æ —Ç—Ä–µ–±—É–µ—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –≤ —Å–ª–µ–¥—É—é—â–µ–º –ø–µ—Ä–∏–æ–¥–µ: –ü—É–±–ª–∏–∫–∞—Ü–∏–∏ –ú–ò–î –†–§ –æ –Ω–æ–≤—ã—Ö —Ç–æ—Ä–≥–æ–≤—ã—Ö —Å–æ–≥–ª–∞—à–µ–Ω–∏—è—Ö, —Ä–µ—à–µ–Ω–∏—è –ï–≤—Ä–æ–ø–µ–π—Å–∫–æ–≥–æ —Å—É–¥–∞ –ø–æ —Å–∞–Ω–∫—Ü–∏—è–º, –¥–∏–Ω–∞–º–∏–∫–∞ —Ü–µ–Ω –Ω–∞ —ç–Ω–µ—Ä–≥–æ–Ω–æ—Å–∏—Ç–µ–ª–∏, –∑–∞—è–≤–ª–µ–Ω–∏—è –ö–∏—Ç–∞—è –æ –ø–æ—Å—Ç–∞–≤–∫–∞—Ö –≤—ã—Å–æ–∫–æ—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤."
    ])

    full_text = "\n".join(summary_lines)
    return full_text[:2000]

async def send_report_async():
    app = Application.builder().token(TELEGRAM_TOKEN).build()
    try:
        # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Å—Ç–∞—Ç—å–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞
        now = datetime.now(timezone.utc)
        yesterday = now - timedelta(days=1)
        response = supabase.table("published_articles") \
            .select("*") \
            .gte("created_at", yesterday.isoformat()) \
            .order("created_at", desc=True) \
            .execute()

        articles = response.data
        if not articles:
            report = "–ù–µ—Ç –Ω–æ–≤—ã—Ö —Å—Ç–∞—Ç–µ–π –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞."
        else:
            report = generate_analytical_summary(articles)

        await app.bot.send_message(chat_id=TARGET_CHANNEL_ID, text=report)
        print("‚úÖ –û—Ç—á—ë—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω")

        # –û—Ç–º–µ—á–∞–µ–º —Å—Ç–∞—Ç—å–∏ –∫–∞–∫ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ (–µ—Å–ª–∏ –µ—Å—Ç—å –ø–æ–ª–µ is_analyzed)
        # –ï—Å–ª–∏ –Ω–µ—Ç, –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —ç—Ç–æ –ø–æ–ª–µ –≤ —Ç–∞–±–ª–∏—Ü—É
        # supabase.table("published_articles").update({"is_analyzed": True}).gte("created_at", yesterday.isoformat()).execute()

        return True
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: {e}")
        return False

# === Flask —Å–µ—Ä–≤–µ—Ä ===
flask_app = Flask(__name__)

@flask_app.route("/")
def home():
    return "ü§ñ –§–∏–Ω–∞–Ω—Å–∏—Å—Ç-–ê–Ω–∞–ª–∏—Ç–∏–∫: –ë–æ—Ç –∞–∫—Ç–∏–≤–µ–Ω –∏ –≥–æ—Ç–æ–≤ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫—É.", 200

# –ú–∞—Ä—à—Ä—É—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –æ—Ç—á—ë—Ç–∞ –≤—Ä—É—á–Ω—É—é
@flask_app.route("/trigger-report")
def trigger_report():
    print("üîç –ó–∞–ø—Ä–æ—Å –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –æ—Ç—á—ë—Ç–∞...")
    loop = asyncio.new_event_loop()
    asyncio.set_event_loop(loop)
    try:
        success = loop.run_until_complete(send_report_async())
    finally:
        loop.close()

    if success:
        return jsonify({"status": "success", "message": "–û—Ç—á—ë—Ç —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω"}), 200
    else:
        return jsonify({"status": "error", "message": "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –æ—Ç—á—ë—Ç–∞"}), 200

# Gunicorn –∑–∞–ø—É—Å—Ç–∏—Ç flask_app, –ø–æ—ç—Ç–æ–º—É –±–ª–æ–∫ if __name__ == "__main__" –Ω–µ –Ω—É–∂–µ–Ω
